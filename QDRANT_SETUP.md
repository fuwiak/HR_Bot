# Настройка Qdrant для векторного поиска услуг

## Что делает Qdrant?

Qdrant - векторная база данных, которая хранит услуги из Google Sheets в виде эмбеддингов. Это позволяет выполнять семантический поиск, находить услуги даже если пользователь написал их по-другому (например, "бритье головы" найдет "Бритье головы").

**Преимущества:**
- ✅ Точный поиск услуг по смыслу
- ✅ Нет выдумывания цен AI - используются только данные из Google Sheets
- ✅ Автоматическое обновление при изменениях в Google Sheets

## Установка Qdrant

### Вариант 1: Локально (для разработки)

```bash
# Используя Docker
docker run -p 6333:6333 -p 6334:6334 qdrant/qdrant

# Или через pip (легковесная версия для тестирования)
pip install qdrant-client
```

### Вариант 2: Qdrant Cloud (для продакшена на Railway) ✅ РЕКОМЕНДУЕТСЯ

**Ваш кластер уже создан:**
- **Endpoint**: `https://239a4026-d673-4b8b-bfab-a99c7044e6b1.us-east4-0.gcp.cloud.qdrant.io`
- **Cluster ID**: `239a4026-d673-4b8b-bfab-a99c7044e6b1`

**Шаги для настройки:**

1. **Получите API ключ:**
   - Войдите в https://cloud.qdrant.io
   - Выберите ваш кластер
   - Перейдите в раздел "API Keys"
   - Создайте новый API ключ или используйте существующий
   - Скопируйте API ключ

2. **Установите переменные окружения в Railway:**
   - Перейдите в дашборд Railway
   - Выберите ваш сервис бота
   - Откройте вкладку "Variables"
   - Добавьте две переменные:
     ```
     QDRANT_URL=https://239a4026-d673-4b8b-bfab-a99c7044e6b1.us-east4-0.gcp.cloud.qdrant.io
     QDRANT_API_KEY=ваш_api_ключ_из_qdrant_cloud
     ```

3. **Перезапустите сервис** - Railway сделает это автоматически после добавления переменных

### Вариант 3: Railway (если используете Railway для деплоя)

Добавьте Qdrant как сервис в Railway или используйте внешний Qdrant Cloud.

## Переменные окружения

```bash
# Опционально (по умолчанию: http://localhost:6333)
QDRANT_URL=http://localhost:6333

# Опционально (если используете Qdrant Cloud)
QDRANT_API_KEY=your_api_key
```

## Как это работает

1. **При старте бота:**
   - Бот читает все услуги из Google Sheets
   - Создает эмбеддинги для каждой услуги
   - Сохраняет их в Qdrant

2. **При поиске услуги:**
   - Пользователь пишет "Бритье головы?"
   - Бот создает эмбеддинг для этого запроса
   - Ищет в Qdrant наиболее похожую услугу
   - Возвращает точную цену из Google Sheets (1700₽)

3. **При изменениях в Google Sheets:**
   - Индекс автоматически обновляется при чтении данных
   - Qdrant всегда содержит актуальные данные

## Проверка работы

После запуска бота в логах должно быть:
```
✅ Qdrant клиент успешно подключен: http://localhost:6333
✅ Модель для эмбеддингов загружена
✅ Создана коллекция 'romanbot_services' в Qdrant
✅ Индексировано X услуг в Qdrant
```

## Если Qdrant недоступен

Бот продолжит работать, но будет использовать обычный текстовый поиск вместо векторного. В логах будет:
```
⚠️ Qdrant модуль не доступен
```

## Производительность

- Первый запуск: может занять 1-2 минуты (загрузка модели эмбеддингов)
- Последующие запуски: быстро (модель кэшируется)
- Поиск: <100ms (очень быстро)

## Модель эмбеддингов

Используется `intfloat/multilingual-e5-base` - поддерживает русский язык и работает хорошо для поиска услуг.

