# Интеграция календаря для генерации КП

## Описание

Система автоматически использует информацию о календаре при генерации коммерческих предложений (КП), чтобы предлагать реальные доступные даты начала проектов.

## Как это работает

1. **Получение информации о календаре**: Система проверяет занятые периоды в WEEEK (задачи с дедлайнами)
2. **Расчет доступных дат**: Находит ближайшие свободные даты для начала проектов
3. **Интеграция в КП**: Информация о доступных датах передается в промпт для генерации КП

## Файлы

- `services/helpers/calendar_helper.py` - модуль для работы с календарем
- `services/agents/lead_processor.py` - обновлен для использования календаря

## Использование

### Автоматическое использование

По умолчанию календарь используется автоматически при генерации КП:

```python
from services.agents.lead_processor import generate_proposal

proposal = await generate_proposal(
    lead_request="Нужна помощь с автоматизацией HR-процессов",
    lead_contact={"email": "client@example.com"},
    use_calendar=True  # По умолчанию True
)
```

### Отключение календаря

Если нужно отключить использование календаря:

```python
proposal = await generate_proposal(
    lead_request="...",
    lead_contact={...},
    use_calendar=False
)
```

### Прямое использование calendar_helper

```python
from services.helpers.calendar_helper import get_available_dates, format_calendar_info_for_prompt

# Получить информацию о доступных датах
calendar_info = await get_available_dates(days_ahead=60)

# Форматировать для промпта
calendar_text = await format_calendar_info_for_prompt(calendar_info)
```

## Что возвращает get_available_dates()

```python
{
    "available_weeks": ["неделя с 07.02.2026", "неделя с 14.02.2026", ...],
    "busy_periods": ["15.02.2026 - 20.02.2026", ...],
    "earliest_start": "07.02.2026",
    "recommended_start": "14.02.2026"
}
```

## Интеграция с WEEEK

Система автоматически использует WEEEK API для получения информации о занятых периодах:
- Проверяет задачи с дедлайнами на ближайшие 60 дней
- Помечает даты как занятые (2 дня до и 2 дня после дедлайна)
- Находит свободные периоды для планирования

Если WEEEK недоступен, система возвращает базовую информацию:
- Ближайшая дата: через 7 дней
- Рекомендуемая дата: через 14 дней

## Пример использования в КП

При генерации КП система автоматически включает информацию о календаре:

```
Информация о календаре (реальные доступные даты):
Ближайшая доступная дата начала проекта: 07.02.2026
Рекомендуемая дата начала проекта: 14.02.2026
Доступные недели для старта: неделя с 07.02.2026, неделя с 14.02.2026, ...
Занятые периоды (учитывать при планировании): 15.02.2026 - 20.02.2026, ...
```

LLM использует эту информацию для предложения реальных дат в коммерческом предложении.

## Настройка

Для работы с WEEEK необходимо установить переменные окружения:
- `WEEEEK_TOKEN` или `WEEEK_API_KEY` - API ключ WEEEK
- `WEEEK_WORKSPACE_ID` - ID рабочего пространства

Если WEEEK не настроен, система работает в режиме fallback с базовыми датами.
