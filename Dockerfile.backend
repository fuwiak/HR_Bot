# Dockerfile –¥–ª—è Backend API —Å–µ—Ä–≤–∏—Å–∞
FROM python:3.11-slim

WORKDIR /app

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .

# Install Python dependencies
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# Copy application code
COPY backend/ ./backend/
COPY services/ ./services/
COPY tests/ ./tests/
COPY scripts/ ./scripts/
COPY config.yaml .
COPY config/ ./config/
COPY templates/ ./templates/
COPY dashboard_static/ ./dashboard_static/

# Expose port for backend API
EXPOSE 8081

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
ARG RUN_TESTS=false
ENV RUN_TESTS=${RUN_TESTS}
ARG RUN_SERVICES_MIGRATION=false
ENV RUN_SERVICES_MIGRATION=${RUN_SERVICES_MIGRATION}

# –°–æ–∑–¥–∞–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Qdrant –∏ —É—Å–ª–æ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
RUN echo '#!/bin/sh\n\
echo "üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π Alembic..."\n\
alembic upgrade head || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"\n\
echo "üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–∏..."\n\
python scripts/init_qdrant.py || echo "‚ö†Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Qdrant –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"\n\
if [ "$RUN_SERVICES_MIGRATION" = "true" ]; then\n\
    echo "üì¶ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –≤ RAG –∫–æ–ª–ª–µ–∫—Ü–∏—é..."\n\
    python scripts/migrate_services_to_rag.py || echo "‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è —É—Å–ª—É–≥ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"\n\
fi\n\
if [ "$RUN_TESTS" = "true" ]; then\n\
    echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."\n\
    python tests/run_tests.py || echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫"\n\
fi\n\
exec python -u backend/web_interface.py\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

# –ò—Å–ø–æ–ª—å–∑—É–µ–º entrypoint –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
ENTRYPOINT ["/entrypoint.sh"]
