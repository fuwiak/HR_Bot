"""
Proposal Generator Module
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≥–∏–ø–æ—Ç–µ–∑
"""
import logging
from typing import Dict, List, Optional
from datetime import datetime

log = logging.getLogger()

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è LLM –∏ RAG
try:
    from services.helpers.llm_helper import generate_with_fallback
    from services.rag.qdrant_helper import search_service
    LLM_AVAILABLE = True
except ImportError:
    LLM_AVAILABLE = False
    log.warning("‚ö†Ô∏è LLM –∏–ª–∏ RAG –º–æ–¥—É–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")

# ===================== PROMPTS =====================

CLASSIFICATION_PROMPT = """
–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:
- "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è HR-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º
- "–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑" - –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥
- "–¥—Ä—É–≥–æ–µ" - –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
    "category": "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" | "–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑" | "–¥—Ä—É–≥–æ–µ",
    "confidence": 0.0-1.0,
    "keywords": ["–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ 1", "–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ 2"]
}

–ó–∞–ø—Ä–æ—Å: {{request}}
"""

PROPOSAL_GENERATION_PROMPT = """
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π HR‚Äë–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å HR‚Äë–ø—Ä–æ–µ–∫—Ç–æ–≤.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–∏—Å–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ö–ü) –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–æ HR/–æ—Ü–µ–Ω–∫–µ/—Ä–∞–∑–≤–∏—Ç–∏—é, –≤ –¥–µ–ª–æ–≤–æ–º, –Ω–æ –∂–∏–≤–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º —Å—Ç–∏–ª–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ï:
- –†–∞–±–æ—Ç–∞–µ—Ç –û–î–ò–ù –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞
- –ò—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ: "—è", "–º–Ω–µ", "—è –ø—Ä–æ–≤–µ–¥—É", "—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é", "—è –≤—ã–ø–æ–ª–Ω—é"
- –í—Å–µ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–π, —á—Ç–æ —Ä–∞–±–æ—Ç—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞ –ª–∏—á–Ω–æ
- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫: "–Ø (–ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞) –ø—Ä–æ–≤–µ–¥—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É", "–Ø –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "–Ø –≤—ã–ø–æ–ª–Ω—é —Ä–∞–±–æ—Ç—É"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ë–†–ê–©–ï–ù–ò–ï –ö –ö–õ–ò–ï–ù–¢–£:
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π "–≤—ã" –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É (–≤–∞—Å, –≤–∞–º, –≤–∞—à, –≤–∞—à–∞ –∏ —Ç.–¥.)
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π "—Ç—ã" –∏–ª–∏ "—Ç–µ–±–µ" - —Ç–æ–ª—å–∫–æ "–≤—ã" –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ä–º—ã
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ "–ü—Ä–∏–≤–µ—Ç" - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ" –∏–ª–∏ "–î–æ–±—Ä—ã–π –¥–µ–Ω—å"

–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:
- –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ (¬´—è –ø—Ä–µ–¥–ª–∞–≥–∞—é¬ª, ¬´—è —Å–¥–µ–ª–∞—é¬ª) - —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–¥–∏–Ω –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ –±–ª–æ–∫–∞–º —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏: ¬´–ö—Ä–∞—Ç–∫–æ –æ –∑–∞–¥–∞—á–µ¬ª, ¬´–ú–æ–π –ø–æ–¥—Ö–æ–¥¬ª, ¬´–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã¬ª, ¬´–°—Ä–æ–∫–∏¬ª, ¬´–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç¬ª, ¬´–ü–æ—á–µ–º—É —è¬ª
- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–µ–ª–æ–≤—ã–µ, –±–µ–∑ –≤–æ–¥—ã, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
- –û–±—ä—ë–º –æ—Ç–≤–µ—Ç–∞: 2‚Äì5 –∞–±–∑–∞—Ü–µ–≤ + –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–ø–∏—Å–∫–∏
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏ *, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è __, –∑–∞–≥–æ–ª–æ–≤–∫–∏ #, ### –∏ —Ç.–¥.) - –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä "–ö—Ä–∞—Ç–∫–æ –æ –∑–∞–¥–∞—á–µ:" –±–µ–∑ —Å–∏–º–≤–æ–ª–æ–≤

–§–û–†–ú–ê–¢ –î–õ–Ø –ó–ê–ü–†–û–°–û–í –¢–ò–ü–ê ¬´–ü—Ä–æ–∫–∞—á–∞—Ç—å –æ—Ç–¥–µ–ª —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥–∞ / –≤—ã—Ä–∞—Å—Ç–∏—Ç—å HRD¬ª:
- –í –Ω–∞—á–∞–ª–µ –∫—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –û–ø–∏—à–∏ –ø–æ–¥—Ö–æ–¥: —Å–æ–≤–º–µ—Å—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ, —Ä–∞–±–æ—Ç–∞ —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º–∏, –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Ä–æ–ª–∏ HR –∫–∞–∫ –±–∏–∑–Ω–µ—Å‚Äë–ø–∞—Ä—Ç–Ω—ë—Ä–∞
- –°—Ñ–æ—Ä–º–∏—Ä—É–π 3‚Äì5 —ç—Ç–∞–ø–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞, –¥–∏–∑–∞–π–Ω HR‚Äë—Ñ—É–Ω–∫—Ü–∏–∏, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –æ–±—É—á–µ–Ω–∏–µ/–Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ, –∫—É—Ä–∞—Ç–æ—Ä—Å—Ç–≤–æ)
- –£–∫–∞–∂–∏ —Ñ–æ—Ä–º–∞—Ç –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç–∏: –ø–µ—Ä–≤—ã–µ –ø–æ–ª–≥–æ–¥–∞ –ø–ª–æ—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –¥–∞–ª–µ–µ ‚Äî –∫—É—Ä–∞—Ç–æ—Ä—Å—Ç–≤–æ/—Å–µ—Å—Å–∏–∏
- –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å –º—è–≥–∫–∏–π call‚Äëto‚Äëaction: –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–∑–≤–æ–Ω/–ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ Telegram –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π

–§–û–†–ú–ê–¢ –î–õ–Ø –ó–ê–ü–†–û–°–û–í –¢–ò–ü–ê ¬´–û—Ü–µ–Ω–∫–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π / —Ç–µ–Ω–¥–µ—Ä¬ª:
- –ö—Ä–∞—Ç–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä—É–π —Ü–µ–ª—å –∫–ª–∏–µ–Ω—Ç–∞ (—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–¥—Ä–æ–≤–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–∞, —Ä–µ–π—Ç–∏–Ω–≥ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π, —Ä–µ—à–µ–Ω–∏—è –ø–æ —Ä–∞–∑–≤–∏—Ç–∏—é)
- –ß—ë—Ç–∫–æ —Ä–∞–∑–ª–æ–∂–∏ —ç—Ç–∞–ø—ã, –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É—è—Å—å –Ω–∞ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ –¢–ó:
  - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ–ª–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π
  - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤
  - –¥–∏–∑–∞–π–Ω –∞—Å—Å–µ—Å—Å–º–µ–Ω—Ç‚Äë—Ü–µ–Ω—Ç—Ä–∞
  - —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ 360
  - –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
  - –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã
  - —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞–≤–∞–π –ø—Ä–∏–º–µ—Ä–Ω—É—é –ª–æ–≥–∏–∫—É —Å—Ä–æ–∫–æ–≤ (–≤ –Ω–µ–¥–µ–ª—è—Ö) –∏ —É–∫–∞–∑—ã–≤–∞–π, —á—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –∏ –±—é–¥–∂–µ—Ç —É—Ç–æ—á–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –±—Ä–∏—Ñ–∏–Ω–≥–∞
- –û–ø–∏—à–∏ —Å–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç—ã (—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞, –≤–µ–¥—É—â–∏–µ –∞—Å—Å–µ—Å—Å–æ—Ä—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫) –∏ –ø–æ–¥—á–µ—Ä–∫–Ω–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ–ø—ã—Ç
- –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ª–µ–≥–∫–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ/—Ç–µ–Ω–¥–µ—Ä–Ω—É—é –∑–∞—è–≤–∫—É

–û–°–û–ë–û–ï:
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ —É–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–¥–ª–∞–π–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–¥–æ 19 —Ñ–µ–≤—Ä–∞–ª—è¬ª), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–∞–∑–∏ —ç—Ç–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É–∫—Ä—É–ø–Ω—ë–Ω–Ω—ã–π –ø–ª–∞–Ω, —É–∫–ª–∞–¥—ã–≤–∞—é—â–∏–π—Å—è –≤ —Å—Ä–æ–∫
- –ù–µ —É—Ö–æ–¥–∏ –≤ —Ç–µ–æ—Ä–∏—é HR, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞—Ö, –º–µ—Ç—Ä–∏–∫–∞—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ ¬´–±–ª–∞‚Äë–±–ª–∞ –ø—Ä–æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏¬ª, –ª—É—á—à–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π—Å—è –∫ –∑–∞–¥–∞—á–∞–º –∫–ª–∏–µ–Ω—Ç–∞: —Ä–æ—Å—Ç, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–∞–¥—Ä–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤, –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π
- –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–π —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫—É –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ –ö–ü –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–≤–∫–∏

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–†–û–ö–ò –ò –î–ê–¢–´:
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–∏–∂–µ
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞—Ç—ã - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —É–∫–∞–∑–∞–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ"
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ "–±–ª–∏–∂–∞–π—à–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–∞—Ç–∞" - –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ "—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞" - –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –£—á–∏—Ç—ã–≤–∞–π –∑–∞–Ω—è—Ç—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç—Ç–∞–ø–æ–≤
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–π –¥–µ–¥–ª–∞–π–Ω - –ø—Ä–æ–≤–µ—Ä—å, —Ä–µ–∞–ª—å–Ω–æ –ª–∏ —É–ª–æ–∂–∏—Ç—å—Å—è —Å —É—á–µ—Ç–æ–º –∑–∞–Ω—è—Ç—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∫–µ–π—Å—ã –∏–ª–∏ –º–µ—Ç–æ–¥–∏–∫–∏.

{{conversation_history}}

–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {{request}}

–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{{rag_context}}

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã):
{{calendar_info}}
"""

HYPOTHESIS_GENERATION_PROMPT = """
–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞. –ù–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã.

–§–æ—Ä–º–∞—Ç:
1. –û—Å–Ω–æ–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ —Ä–µ—à–µ–Ω–∏—è
2. –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∫–µ–π—Å—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {{request}}

–ü–æ—Ö–æ–∂–∏–µ –∫–µ–π—Å—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{{rag_context}}
"""

# ===================== VALIDATION =====================

async def validate_lead(lead_request: str) -> Dict:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ª–∏–¥–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–≤—Å–µ–≥–¥–∞ "—Ç–µ–ø–ª—ã–π" –ª–∏–¥)
    """
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è "—Ç–µ–ø–ª—ã–º–∏" –ª–∏–¥–∞–º–∏
    result = {
        "score": 1.0,
        "status": "warm",
        "reason": "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏",
        "criteria": {
            "clarity": 1.0,
            "budget": 0.5,
            "relevance": 1.0
        }
    }
    
    log.info(f"‚úÖ –õ–∏–¥ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω: score={result.get('score')}, status={result.get('status')}")
    return result

async def classify_request(request: str) -> Dict:
    """
    –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
    
    Args:
        request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
    """
    if not LLM_AVAILABLE:
        return {
            "category": "–¥—Ä—É–≥–æ–µ",
            "confidence": 0.0,
            "keywords": []
        }
    
    try:
        prompt = CLASSIFICATION_PROMPT.replace("{{request}}", request)
        
        messages = [{"role": "user", "content": prompt}]
        response = await generate_with_fallback(messages, use_system_message=True, system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.")
        
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞
        import json
        if "{" in response and "}" in response:
            json_start = response.find("{")
            json_end = response.rfind("}") + 1
            json_str = response[json_start:json_end]
            result = json.loads(json_str)
        else:
            result = {
                "category": "–¥—Ä—É–≥–æ–µ",
                "confidence": 0.0,
                "keywords": []
            }
        
        log.info(f"‚úÖ –ó–∞–ø—Ä–æ—Å –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: {result.get('category')} (confidence: {result.get('confidence')})")
        return result
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return {
            "category": "–¥—Ä—É–≥–æ–µ",
            "confidence": 0.0,
            "keywords": []
        }

# ===================== PROPOSAL GENERATION =====================

async def generate_proposal(lead_request: str, lead_contact: Dict, rag_results: Optional[List[Dict]] = None, conversation_history: Optional[str] = None, use_calendar: bool = True) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ª–∏–¥–∞
        lead_contact: –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ª–∏–¥–∞
        rag_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ RAG –±–∞–∑–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        conversation_history: –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        use_calendar: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
    
    Returns:
        –¢–µ–∫—Å—Ç –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    """
    log.info(f"üöÄ [–ö–ü] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü. –ó–∞–ø—Ä–æ—Å: {lead_request[:100]}...")
    
    if not LLM_AVAILABLE:
        log.error("‚ùå [–ö–ü] LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    
    try:
        # –®–∞–≥ 1: –ü–æ–∏—Å–∫ –≤ RAG –±–∞–∑–µ
        log.info("üìö [–ö–ü] –®–∞–≥ 1: –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ RAG –±–∞–∑–µ")
        if rag_results is None:
            log.info(f"üìö [–ö–ü] –í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {lead_request[:100]}...")
            rag_results = search_service(lead_request, limit=5)
            log.info(f"üìö [–ö–ü] –ù–∞–π–¥–µ–Ω–æ {len(rag_results) if rag_results else 0} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
        else:
            log.info(f"üìö [–ö–ü] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ({len(rag_results)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)")
        
        # –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        log.info("üìù [–ö–ü] –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
        rag_context = ""
        if rag_results:
            rag_context = "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n\n"
            for i, result in enumerate(rag_results, 1):
                title = result.get("title", "–î–æ–∫—É–º–µ–Ω—Ç")
                text = result.get("text", result.get("content", ""))[:500]  # –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
                score = result.get("score", 0)
                rag_context += f"{i}. {title} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score:.2f})\n{text}\n\n"
                log.info(f"üìù [–ö–ü] –î–æ–±–∞–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç {i}: {title} (score: {score:.2f})")
            log.info(f"üìù [–ö–ü] –ö–æ–Ω—Ç–µ–∫—Å—Ç RAG —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω ({len(rag_context)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            rag_context = "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞."
            log.warning("‚ö†Ô∏è [–ö–ü] –í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        
        # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã
        log.info("üí¨ [–ö–ü] –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã")
        history_context = ""
        if conversation_history and conversation_history.strip():
            history_context = f"–ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º:\n{conversation_history}\n\n"
            log.info(f"üí¨ [–ö–ü] –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∞ ({len(conversation_history)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            history_context = ""
            log.info("üí¨ [–ö–ü] –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–∞")
        
        # –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        log.info("üìÖ [–ö–ü] –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ")
        calendar_info_text = ""
        if use_calendar:
            try:
                from services.helpers.calendar_helper import format_calendar_info_for_prompt
                calendar_info_text = await format_calendar_info_for_prompt()
                log.info(f"üìÖ [–ö–ü] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –ø–æ–ª—É—á–µ–Ω–∞ ({len(calendar_info_text)} —Å–∏–º–≤–æ–ª–æ–≤)")
            except Exception as e:
                log.warning(f"‚ö†Ô∏è [–ö–ü] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: {e}")
                calendar_info_text = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏ –≤ –Ω–µ–¥–µ–ª—è—Ö."
        else:
            calendar_info_text = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏ –≤ –Ω–µ–¥–µ–ª—è—Ö."
            log.info("üìÖ [–ö–ü] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –æ—Ç–∫–ª—é—á–µ–Ω–æ")
        
        # –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
        log.info("üìã [–ö–ü] –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM")
        prompt = PROPOSAL_GENERATION_PROMPT.replace("{{conversation_history}}", history_context).replace("{{request}}", lead_request).replace("{{rag_context}}", rag_context).replace("{{calendar_info}}", calendar_info_text)
        log.info(f"üìã [–ö–ü] –ü—Ä–æ–º–ø—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω ({len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        # –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM
        log.info("ü§ñ [–ö–ü] –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü")
        messages = [{"role": "user", "content": prompt}]
        proposal = await generate_with_fallback(
            messages,
            use_system_message=True,
            system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –ü–∏—à–∏ –¥–µ–ª–æ–≤—ã–º, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º —Å—Ç–∏–ª–µ–º. –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –†–∞–±–æ—Ç–∞–µ—Ç –û–î–ò–ù –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞. –ò—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (—è, –º–Ω–µ, —è –ø—Ä–æ–≤–µ–¥—É), –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (–º—ã, –Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞, –Ω–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã). –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π '–≤—ã' –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É (–≤–∞—Å, –≤–∞–º, –≤–∞—à, –≤–∞—à–∞), –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π '—Ç—ã' –∏–ª–∏ '—Ç–µ–±–µ'. –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ '–ü—Ä–∏–≤–µ—Ç' - –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ' –∏–ª–∏ '–î–æ–±—Ä—ã–π –¥–µ–Ω—å'. –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏ *, –∑–∞–≥–æ–ª–æ–≤–∫–∏ #, ### –∏ —Ç.–¥.) - –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.",
            max_tokens=3000,
            temperature=0.7
        )
        
        log.info(f"‚úÖ [–ö–ü] –®–∞–≥ 7: –ö–ü —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ (–¥–ª–∏–Ω–∞: {len(proposal)} —Å–∏–º–≤–æ–ª–æ–≤)")
        log.info(f"‚úÖ [–ö–ü] –ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        return proposal
    except Exception as e:
        log.error(f"‚ùå [–ö–ü] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü –Ω–∞ —ç—Ç–∞–ø–µ: {e}")
        import traceback
        log.error(f"‚ùå [–ö–ü] Traceback: {traceback.format_exc()}")
        return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –û—à–∏–±–∫–∞: {str(e)}"

async def generate_hypothesis(lead_request: str, rag_results: Optional[List[Dict]] = None) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
        rag_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ RAG –±–∞–∑–µ
    
    Returns:
        –¢–µ–∫—Å—Ç —Å –≥–∏–ø–æ—Ç–µ–∑–∞–º–∏
    """
    if not LLM_AVAILABLE:
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    
    try:
        # –ï—Å–ª–∏ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –∏—â–µ–º –∏—Ö
        if rag_results is None:
            rag_results = search_service(lead_request, limit=5)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤
        rag_context = ""
        if rag_results:
            rag_context = "–ü–æ—Ö–æ–∂–∏–µ –∫–µ–π—Å—ã –∏ –º–µ—Ç–æ–¥–∏–∫–∏:\n\n"
            for i, result in enumerate(rag_results, 1):
                title = result.get("title", "–ö–µ–π—Å")
                text = result.get("text", result.get("content", ""))[:500]
                category = result.get("category", "–∫–µ–π—Å")
                rag_context += f"{i}. [{category}] {title}\n{text}\n\n"
        else:
            rag_context = "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤."
        
        prompt = HYPOTHESIS_GENERATION_PROMPT.replace("{{request}}", lead_request).replace("{{rag_context}}", rag_context)
        
        messages = [{"role": "user", "content": prompt}]
        hypothesis = await generate_with_fallback(
            messages,
            use_system_message=True,
            system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑. –ò—Å–ø–æ–ª—å–∑—É–π –æ–ø—ã—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.",
            max_tokens=2000,
            temperature=0.7
        )
        
        log.info(f"‚úÖ –ì–∏–ø–æ—Ç–µ–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ (–¥–ª–∏–Ω–∞: {len(hypothesis)} —Å–∏–º–≤–æ–ª–æ–≤)")
        return hypothesis
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑—ã: {e}")
        return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑. –û—à–∏–±–∫–∞: {str(e)}"


# ===================== LEAD DETECTION =====================

async def detect_lead(message: str) -> Dict:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–¥–∞ - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏
    
    Args:
        message: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (–≤—Å–µ–≥–¥–∞ is_lead=True):
        - is_lead: bool - –≤—Å–µ–≥–¥–∞ True
        - confidence: float - –≤—Å–µ–≥–¥–∞ 1.0
        - reason: str - –ø—Ä–∏—á–∏–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    """
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏
    result = {
        "is_lead": True,
        "confidence": 1.0,
        "reason": "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏"
    }
    
    log.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ –ª–∏–¥ (confidence: {result.get('confidence'):.2f})")
    return result
























