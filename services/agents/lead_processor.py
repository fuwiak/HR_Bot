"""
Proposal Generator Module
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≥–∏–ø–æ—Ç–µ–∑
"""
import logging
from typing import Dict, List, Optional
from datetime import datetime

log = logging.getLogger()

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è LLM –∏ RAG
try:
    from services.helpers.llm_helper import generate_with_fallback
    from services.rag.qdrant_helper import search_service
    LLM_AVAILABLE = True
except ImportError:
    LLM_AVAILABLE = False
    log.warning("‚ö†Ô∏è LLM –∏–ª–∏ RAG –º–æ–¥—É–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")

# ===================== PROMPTS =====================

CLASSIFICATION_PROMPT = """
–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏. –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:
- "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è HR-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º
- "–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑" - –∞–Ω–∞–ª–∏–∑ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥
- "–¥—Ä—É–≥–æ–µ" - –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–û—Ç–≤–µ—Ç—å –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{
    "category": "–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è" | "–±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑" | "–¥—Ä—É–≥–æ–µ",
    "confidence": 0.0-1.0,
    "keywords": ["–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ 1", "–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ 2"]
}

–ó–∞–ø—Ä–æ—Å: {{request}}
"""

PROPOSAL_GENERATION_PROMPT = """
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π HR‚Äë–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å HR‚Äë–ø—Ä–æ–µ–∫—Ç–æ–≤.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–ö–ü) –≤ –æ—Ç–≤–µ—Ç –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∑–∞–∫–∞–∑—á–∏–∫–∞ –ø–æ HR/–æ—Ü–µ–Ω–∫–µ/—Ä–∞–∑–≤–∏—Ç–∏—é, –≤ –¥–µ–ª–æ–≤–æ–º, –Ω–æ –∂–∏–≤–æ–º –∏ –ø–æ–Ω—è—Ç–Ω–æ–º —Å—Ç–∏–ª–µ.

–ó–û–õ–û–¢–û–ô –°–¢–ê–ù–î–ê–†–¢ –§–û–†–ú–ê–¢–ê –ö–ü - –°–¢–†–û–ì–û –°–õ–ï–î–£–ô –≠–¢–û–ú–£ –§–û–†–ú–ê–¢–£:

1. –ù–ê–ß–ê–õ–û (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
"–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å. –Ø, –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞, —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É –≤–∞–º —Å [–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏]. –£—á–∏—Ç—ã–≤–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞ [–µ—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ –∫–ª–∏–µ–Ω—Ç–∞], –ø—Ä–µ–¥–ª–∞–≥–∞—é —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥:"

2. –°–¢–†–£–ö–¢–£–†–ê (–≤—Å–µ–≥–¥–∞ –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ):

–ö—Ä–∞—Ç–∫–æ –æ –∑–∞–¥–∞—á–µ:  
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –∫—Ä–∞—Ç–∫–æ –ø–µ—Ä–µ—Å–∫–∞–∂–∏ –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—É—Ç—å –∑–∞–¥–∞—á–∏]

–ú–æ–π –ø–æ–¥—Ö–æ–¥:  
[1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–≤–æ—ë–º –ø–æ–¥—Ö–æ–¥–µ –∫ —Ä–µ—à–µ–Ω–∏—é –∑–∞–¥–∞—á–∏, –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç]

–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:  
[–ù—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑ 3-7 —ç—Ç–∞–ø–æ–≤, –∫–∞–∂–¥—ã–π —ç—Ç–∞–ø - –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å —Ç–æ—á–∫–æ–π –≤ –∫–æ–Ω—Ü–µ]
1. [–≠—Ç–∞–ø 1].  
2. [–≠—Ç–∞–ø 2].  
3. [–≠—Ç–∞–ø 3].  
...

–°—Ä–æ–∫–∏:  
[–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ä–æ–∫–∏ –≤ –Ω–µ–¥–µ–ª—è—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–æ–µ–∫—Ç –∑–∞–π–º—ë—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ 6‚Äì8 –Ω–µ–¥–µ–ª—å, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–ª—É–±–∏–Ω—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±—ä—ë–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π."]

–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç:  
[–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å—É–º–º–∞ "–æ—Ç X —Ä—É–±–ª–µ–π" –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞—Ç—å —á—Ç–æ —Ç–æ—á–Ω–∞—è —Å—É–º–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –±—Ä–∏—Ñ–∏–Ω–≥–∞]

–ü–æ—á–µ–º—É —è:  
[2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ —Ç–≤–æ—ë–º –æ–ø—ã—Ç–µ, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–µ–π—Å–∞—Ö, –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –∫–ª–∏–µ–Ω—Ç–∞]

3. –ó–ê–í–ï–†–®–ï–ù–ò–ï (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
"–ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ –∏–ª–∏ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ."

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ï:
- –†–∞–±–æ—Ç–∞–µ—Ç –û–î–ò–ù –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞
- –ò—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ: "—è", "–º–Ω–µ", "—è –ø—Ä–æ–≤–µ–¥—É", "—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª—é", "—è –≤—ã–ø–æ–ª–Ω—é"
- –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è: "–Ø, –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞, —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É –≤–∞–º..."
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π "–º—ã", "–Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞", "–Ω–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã" - —Ç–æ–ª—å–∫–æ "—è"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –û–ë–†–ê–©–ï–ù–ò–ï –ö –ö–õ–ò–ï–ù–¢–£:
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π "–≤—ã" –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É (–≤–∞—Å, –≤–∞–º, –≤–∞—à, –≤–∞—à–∞ –∏ —Ç.–¥.)
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π "—Ç—ã" –∏–ª–∏ "—Ç–µ–±–µ" - —Ç–æ–ª—å–∫–æ "–≤—ã" –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–æ—Ä–º—ã
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–û–õ–¨–ö–û: "–î–æ–±—Ä—ã–π –¥–µ–Ω—å!" –∏–ª–∏ "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!"
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π "–ü—Ä–∏–≤–µ—Ç"

–û–ë–©–ò–ï –ü–†–ê–í–ò–õ–ê –°–¢–ò–õ–Ø:
- –ü–∏—à–∏ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ (¬´—è –ø—Ä–µ–¥–ª–∞–≥–∞—é¬ª, ¬´—è —Å–¥–µ–ª–∞—é¬ª)
- –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–µ–ª–æ–≤—ã–µ, –±–µ–∑ –≤–æ–¥—ã, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–≤–µ–∑–¥–æ—á–∫–∏ *, –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è __, –∑–∞–≥–æ–ª–æ–≤–∫–∏ #, ### –∏ —Ç.–¥.) - –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
- –ò—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º: "–ö—Ä–∞—Ç–∫–æ –æ –∑–∞–¥–∞—á–µ:", "–ú–æ–π –ø–æ–¥—Ö–æ–¥:", "–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:", "–°—Ä–æ–∫–∏:", "–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç:", "–ü–æ—á–µ–º—É —è:"
- –í –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ —ç—Ç–∞–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: "1. [—Ç–µ–∫—Å—Ç].  " (—Ç–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ, –¥–≤–∞ –ø—Ä–æ–±–µ–ª–∞ –ø–æ—Å–ª–µ)

–ü–†–ê–í–ò–õ–ê –î–õ–Ø –†–ê–ó–ù–´–• –¢–ò–ü–û–í –ó–ê–ü–†–û–°–û–í:

–î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- –≠—Ç–∞–ø—ã: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Üí –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚Üí –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–æ–≤ ‚Üí –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ
- –°—Ä–æ–∫–∏: 6-8 –Ω–µ–¥–µ–ª—å
- –ë—é–¥–∂–µ—Ç: –æ—Ç 150 000 —Ä—É–±–ª–µ–π

–î–ª—è –ø—Ä–æ–∫–∞—á–∫–∏ –æ—Ç–¥–µ–ª–∞ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥–∞ / –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è HRD:
- –≠—Ç–∞–ø—ã: –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ ‚Üí –¥–∏–∑–∞–π–Ω HR‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ ‚Üí –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ‚Üí –æ–±—É—á–µ–Ω–∏–µ/–Ω–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å—Ç–≤–æ ‚Üí –∫—É—Ä–∞—Ç–æ—Ä—Å—Ç–≤–æ
- –°—Ä–æ–∫–∏: –ø–µ—Ä–≤—ã–µ –ø–æ–ª–≥–æ–¥–∞ –ø–ª–æ—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –¥–∞–ª–µ–µ –∫—É—Ä–∞—Ç–æ—Ä—Å—Ç–≤–æ/—Å–µ—Å—Å–∏–∏
- –ë—é–¥–∂–µ—Ç: –æ—Ç 200 000 —Ä—É–±–ª–µ–π

–î–ª—è –æ—Ü–µ–Ω–∫–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π / —Ç–µ–Ω–¥–µ—Ä:
- –≠—Ç–∞–ø—ã: —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ–ª–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π ‚Üí —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ ‚Üí –¥–∏–∑–∞–π–Ω –∞—Å—Å–µ—Å—Å–º–µ–Ω—Ç‚Äë—Ü–µ–Ω—Ç—Ä–∞ ‚Üí —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ 360 ‚Üí –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ ‚Üí –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã ‚Üí —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –°—Ä–æ–∫–∏: 8-12 –Ω–µ–¥–µ–ª—å
- –ë—é–¥–∂–µ—Ç: –æ—Ç 300 000 —Ä—É–±–ª–µ–π

–û–°–û–ë–û–ï:
- –ï—Å–ª–∏ –∑–∞–∫–∞–∑—á–∏–∫ —É–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ–¥–ª–∞–π–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–¥–æ 19 —Ñ–µ–≤—Ä–∞–ª—è¬ª), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–∞–∑–∏ —ç—Ç–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —É–∫—Ä—É–ø–Ω—ë–Ω–Ω—ã–π –ø–ª–∞–Ω, —É–∫–ª–∞–¥—ã–≤–∞—é—â–∏–π—Å—è –≤ —Å—Ä–æ–∫
- –ù–µ —É—Ö–æ–¥–∏ –≤ —Ç–µ–æ—Ä–∏—é HR, —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞—Ö, –º–µ—Ç—Ä–∏–∫–∞—Ö –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
- –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω–æ–≥–æ ¬´–±–ª–∞‚Äë–±–ª–∞ –ø—Ä–æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏¬ª, –ª—É—á—à–µ –ø—Ä–∏–≤—è–∑—ã–≤–∞–π—Å—è –∫ –∑–∞–¥–∞—á–∞–º –∫–ª–∏–µ–Ω—Ç–∞: —Ä–æ—Å—Ç, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–∞–¥—Ä–æ–≤—ã–π —Ä–µ–∑–µ—Ä–≤, –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π
- –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–µ –±–∏–∑–Ω–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ (–æ—Ç—Ä–∞—Å–ª—å, —Ä–∞–∑–º–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏) - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ —ç—Ç–æ –≤ –Ω–∞—á–∞–ª–µ –∏ —É—á—Ç–∏ –≤ –ø–æ–¥—Ö–æ–¥–µ
- –ö–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç —Ñ–æ—Ä–º–∏—Ä—É–π —Ç–∞–∫, —á—Ç–æ–±—ã –µ–≥–æ –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑—á–∏–∫—É –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ –ö–ü –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–≤–∫–∏

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –°–†–û–ö–ò –ò –î–ê–¢–´:
- –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–∏–∂–µ
- –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π –¥–∞—Ç—ã - –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ —É–∫–∞–∑–∞–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ"
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ "–±–ª–∏–∂–∞–π—à–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–∞—Ç–∞" - –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞
- –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ "—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞" - –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë –∫–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –£—á–∏—Ç—ã–≤–∞–π –∑–∞–Ω—è—Ç—ã–µ –ø–µ—Ä–∏–æ–¥—ã –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç—Ç–∞–ø–æ–≤
- –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å–≤–æ–π –¥–µ–¥–ª–∞–π–Ω - –ø—Ä–æ–≤–µ—Ä—å, —Ä–µ–∞–ª—å–Ω–æ –ª–∏ —É–ª–æ–∂–∏—Ç—å—Å—è —Å —É—á–µ—Ç–æ–º –∑–∞–Ω—è—Ç—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∫–µ–π—Å—ã –∏–ª–∏ –º–µ—Ç–æ–¥–∏–∫–∏.

{{conversation_history}}

–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {{request}}

–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{{rag_context}}

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞—Ç—ã):
{{calendar_info}}
"""

HYPOTHESIS_GENERATION_PROMPT = """
–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞. –ù–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤ –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã.

–§–æ—Ä–º–∞—Ç:
1. –û—Å–Ω–æ–≤–Ω–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ —Ä–µ—à–µ–Ω–∏—è
2. –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –∫–µ–π—Å—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

–ó–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: {{request}}

–ü–æ—Ö–æ–∂–∏–µ –∫–µ–π—Å—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{{rag_context}}
"""

# ===================== VALIDATION =====================

async def validate_lead(lead_request: str) -> Dict:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ª–∏–¥–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–≤—Å–µ–≥–¥–∞ "—Ç–µ–ø–ª—ã–π" –ª–∏–¥)
    """
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è "—Ç–µ–ø–ª—ã–º–∏" –ª–∏–¥–∞–º–∏
    result = {
        "score": 1.0,
        "status": "warm",
        "reason": "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏",
        "criteria": {
            "clarity": 1.0,
            "budget": 0.5,
            "relevance": 1.0
        }
    }
    
    log.info(f"‚úÖ –õ–∏–¥ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω: score={result.get('score')}, status={result.get('status')}")
    return result

async def classify_request(request: str) -> Dict:
    """
    –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
    
    Args:
        request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
    """
    if not LLM_AVAILABLE:
        return {
            "category": "–¥—Ä—É–≥–æ–µ",
            "confidence": 0.0,
            "keywords": []
        }
    
    try:
        prompt = CLASSIFICATION_PROMPT.replace("{{request}}", request)
        
        messages = [{"role": "user", "content": prompt}]
        response = await generate_with_fallback(messages, use_system_message=True, system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.")
        
        # –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞
        import json
        if "{" in response and "}" in response:
            json_start = response.find("{")
            json_end = response.rfind("}") + 1
            json_str = response[json_start:json_end]
            result = json.loads(json_str)
        else:
            result = {
                "category": "–¥—Ä—É–≥–æ–µ",
                "confidence": 0.0,
                "keywords": []
            }
        
        log.info(f"‚úÖ –ó–∞–ø—Ä–æ—Å –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: {result.get('category')} (confidence: {result.get('confidence')})")
        return result
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return {
            "category": "–¥—Ä—É–≥–æ–µ",
            "confidence": 0.0,
            "keywords": []
        }

# ===================== PROPOSAL GENERATION =====================

async def generate_proposal(lead_request: str, lead_contact: Dict, rag_results: Optional[List[Dict]] = None, conversation_history: Optional[str] = None, use_calendar: bool = True) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RAG –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ª–∏–¥–∞
        lead_contact: –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ª–∏–¥–∞
        rag_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ RAG –±–∞–∑–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        conversation_history: –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        use_calendar: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)
    
    Returns:
        –¢–µ–∫—Å—Ç –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    """
    log.info(f"üöÄ [–ö–ü] –ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü. –ó–∞–ø—Ä–æ—Å: {lead_request[:100]}...")
    
    if not LLM_AVAILABLE:
        log.error("‚ùå [–ö–ü] LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    
    try:
        # –®–∞–≥ 1: –ü–æ–∏—Å–∫ –≤ RAG –±–∞–∑–µ
        log.info("üìö [–ö–ü] –®–∞–≥ 1: –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ RAG –±–∞–∑–µ")
        if rag_results is None:
            log.info(f"üìö [–ö–ü] –í—ã–ø–æ–ª–Ω—è—é –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {lead_request[:100]}...")
            rag_results = search_service(lead_request, limit=5)
            log.info(f"üìö [–ö–ü] –ù–∞–π–¥–µ–Ω–æ {len(rag_results) if rag_results else 0} —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
        else:
            log.info(f"üìö [–ö–ü] –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã ({len(rag_results)} –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)")
        
        # –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        log.info("üìù [–ö–ü] –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
        rag_context = ""
        if rag_results:
            rag_context = "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n\n"
            for i, result in enumerate(rag_results, 1):
                title = result.get("title", "–î–æ–∫—É–º–µ–Ω—Ç")
                text = result.get("text", result.get("content", ""))[:500]  # –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤
                score = result.get("score", 0)
                rag_context += f"{i}. {title} (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: {score:.2f})\n{text}\n\n"
                log.info(f"üìù [–ö–ü] –î–æ–±–∞–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç {i}: {title} (score: {score:.2f})")
            log.info(f"üìù [–ö–ü] –ö–æ–Ω—Ç–µ–∫—Å—Ç RAG —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω ({len(rag_context)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            rag_context = "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞."
            log.warning("‚ö†Ô∏è [–ö–ü] –í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
        
        # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã
        log.info("üí¨ [–ö–ü] –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã")
        history_context = ""
        if conversation_history and conversation_history.strip():
            history_context = f"–ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã —Å –∫–ª–∏–µ–Ω—Ç–æ–º:\n{conversation_history}\n\n"
            log.info(f"üí¨ [–ö–ü] –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∞ ({len(conversation_history)} —Å–∏–º–≤–æ–ª–æ–≤)")
        else:
            history_context = ""
            log.info("üí¨ [–ö–ü] –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—É—Å—Ç–∞")
        
        # –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        log.info("üìÖ [–ö–ü] –®–∞–≥ 4: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ")
        calendar_info_text = ""
        if use_calendar:
            try:
                from services.helpers.calendar_helper import format_calendar_info_for_prompt
                calendar_info_text = await format_calendar_info_for_prompt()
                log.info(f"üìÖ [–ö–ü] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –ø–æ–ª—É—á–µ–Ω–∞ ({len(calendar_info_text)} —Å–∏–º–≤–æ–ª–æ–≤)")
            except Exception as e:
                log.warning(f"‚ö†Ô∏è [–ö–ü] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ: {e}")
                calendar_info_text = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏ –≤ –Ω–µ–¥–µ–ª—è—Ö."
        else:
            calendar_info_text = "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏ –≤ –Ω–µ–¥–µ–ª—è—Ö."
            log.info("üìÖ [–ö–ü] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –æ—Ç–∫–ª—é—á–µ–Ω–æ")
        
        # –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
        log.info("üìã [–ö–ü] –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM")
        prompt = PROPOSAL_GENERATION_PROMPT.replace("{{conversation_history}}", history_context).replace("{{request}}", lead_request).replace("{{rag_context}}", rag_context).replace("{{calendar_info}}", calendar_info_text)
        log.info(f"üìã [–ö–ü] –ü—Ä–æ–º–ø—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω ({len(prompt)} —Å–∏–º–≤–æ–ª–æ–≤)")
        
        # –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ LLM
        log.info("ü§ñ [–ö–ü] –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü")
        messages = [{"role": "user", "content": prompt}]
        proposal = await generate_with_fallback(
            messages,
            use_system_message=True,
            system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –°–¢–†–û–ì–û —Å–ª–µ–¥—É–π –∑–æ–ª–æ—Ç–æ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É —Ñ–æ—Ä–º–∞—Ç–∞ –ö–ü. –ù–∞—á–∏–Ω–∞–π —Å '–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å. –Ø, –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞, —Å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ–º –ø–æ–º–æ–≥—É –≤–∞–º...' –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –ö—Ä–∞—Ç–∫–æ –æ –∑–∞–¥–∞—á–µ, –ú–æ–π –ø–æ–¥—Ö–æ–¥, –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã (–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫), –°—Ä–æ–∫–∏, –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç, –ü–æ—á–µ–º—É —è. –ó–∞–≤–µ—Ä—à–∞–π: '–ü—Ä–µ–¥–ª–∞–≥–∞—é –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ —Å–æ–∑–≤–æ–Ω–µ –∏–ª–∏ –≤ –ø–µ—Ä–µ–ø–∏—Å–∫–µ. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.' –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –†–∞–±–æ—Ç–∞–µ—Ç –û–î–ò–ù –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç - –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ù–æ–≤–æ—Å—ë–ª–æ–≤–∞. –ò—Å–ø–æ–ª—å–∑—É–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (—è, –º–Ω–µ), –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ (–º—ã, –Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞). –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π '–≤—ã' –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É, –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π '—Ç—ã'. –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø–∏—à–∏ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.",
            max_tokens=3000,
            temperature=0.7
        )
        
        log.info(f"‚úÖ [–ö–ü] –®–∞–≥ 7: –ö–ü —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ (–¥–ª–∏–Ω–∞: {len(proposal)} —Å–∏–º–≤–æ–ª–æ–≤)")
        log.info(f"‚úÖ [–ö–ü] –ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ")
        return proposal
    except Exception as e:
        log.error(f"‚ùå [–ö–ü] –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ö–ü –Ω–∞ —ç—Ç–∞–ø–µ: {e}")
        import traceback
        log.error(f"‚ùå [–ö–ü] Traceback: {traceback.format_exc()}")
        return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –û—à–∏–±–∫–∞: {str(e)}"

async def generate_hypothesis(lead_request: str, rag_results: Optional[List[Dict]] = None) -> str:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤—ã—Ö –≥–∏–ø–æ—Ç–µ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
    
    Args:
        lead_request: –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
        rag_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ RAG –±–∞–∑–µ
    
    Returns:
        –¢–µ–∫—Å—Ç —Å –≥–∏–ø–æ—Ç–µ–∑–∞–º–∏
    """
    if not LLM_AVAILABLE:
        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
    
    try:
        # –ï—Å–ª–∏ RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –∏—â–µ–º –∏—Ö
        if rag_results is None:
            rag_results = search_service(lead_request, limit=5)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤
        rag_context = ""
        if rag_results:
            rag_context = "–ü–æ—Ö–æ–∂–∏–µ –∫–µ–π—Å—ã –∏ –º–µ—Ç–æ–¥–∏–∫–∏:\n\n"
            for i, result in enumerate(rag_results, 1):
                title = result.get("title", "–ö–µ–π—Å")
                text = result.get("text", result.get("content", ""))[:500]
                category = result.get("category", "–∫–µ–π—Å")
                rag_context += f"{i}. [{category}] {title}\n{text}\n\n"
        else:
            rag_context = "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ—Ö–æ–∂–∏—Ö –∫–µ–π—Å–æ–≤."
        
        prompt = HYPOTHESIS_GENERATION_PROMPT.replace("{{request}}", lead_request).replace("{{rag_context}}", rag_context)
        
        messages = [{"role": "user", "content": prompt}]
        hypothesis = await generate_with_fallback(
            messages,
            use_system_message=True,
            system_content="–¢—ã –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑. –ò—Å–ø–æ–ª—å–∑—É–π –æ–ø—ã—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.",
            max_tokens=2000,
            temperature=0.7
        )
        
        log.info(f"‚úÖ –ì–∏–ø–æ—Ç–µ–∑–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ (–¥–ª–∏–Ω–∞: {len(hypothesis)} —Å–∏–º–≤–æ–ª–æ–≤)")
        return hypothesis
    except Exception as e:
        log.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑—ã: {e}")
        return f"–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–∏–ø–æ—Ç–µ–∑. –û—à–∏–±–∫–∞: {str(e)}"


# ===================== LEAD DETECTION =====================

async def detect_lead(message: str) -> Dict:
    """
    –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–∏–¥–∞ - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏
    
    Args:
        message: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    Returns:
        –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (–≤—Å–µ–≥–¥–∞ is_lead=True):
        - is_lead: bool - –≤—Å–µ–≥–¥–∞ True
        - confidence: float - –≤—Å–µ–≥–¥–∞ 1.0
        - reason: str - –ø—Ä–∏—á–∏–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    """
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞: –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏
    result = {
        "is_lead": True,
        "confidence": 1.0,
        "reason": "–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–∏–¥–∞–º–∏"
    }
    
    log.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ –ª–∏–¥ (confidence: {result.get('confidence'):.2f})")
    return result
























